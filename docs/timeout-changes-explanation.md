# Gemini Review Hook タイムアウト設計ドキュメント

## 設計思想

本ドキュメントは、Gemini Review Hookにおけるタイムアウト処理の設計決定と、その背景にある考え方を説明します。

## アーキテクチャ上の決定

### タイムアウト値の統一（120秒）

**設計上の考慮点:**
- Gemini APIの応答時間は、プロンプトの複雑さとモデルの負荷状態により大きく変動します
- 実測値では30-90秒の範囲が一般的ですが、ピーク時にはより長い時間が必要な場合があります
- 120秒という値は、通常の処理時間に対して約30%の安全マージンを確保しています

**トレードオフ:**
- 長いタイムアウト値は、問題発生時の検出を遅らせる可能性があります
- しかし、誤検出によるレビュー中断は、開発フローへの影響がより大きいと判断しました

### ProモデルとFlashモデルの統一タイムアウト

**設計原則:**
- 一貫性: 両モデルで同じタイムアウト値を使用することで、システムの挙動を予測可能にします
- 簡潔性: 設定値の数を最小限に抑え、メンテナンスコストを削減します

**実装上の利点:**
- デバッグ時の複雑性が軽減されます
- 環境変数による一括制御が可能になります

## 実装戦略

### クロスプラットフォーム対応

システムによって`timeout`コマンドの可用性が異なるため、2つの実装パスを提供しています：

1. **標準実装**（`timeout`コマンドが利用可能な場合）
   ```bash
   timeout ${GEMINI_TIMEOUT}s bash -c "echo '$REVIEW_PROMPT' | gemini -s -y"
   ```

2. **フォールバック実装**（`timeout`コマンドが利用不可能な場合）
   ```bash
   echo "$REVIEW_PROMPT" | gemini -s -y &
   GEMINI_PID=$!
   # 手動でプロセスを監視し、タイムアウトを管理
   ```

この二重実装により、様々な環境での安定動作を保証しています。

### エラーハンドリングとフォールバック

**レート制限対応:**
- Proモデルでレート制限に達した場合、自動的にFlashモデルにフォールバック
- 同じタイムアウト値を使用することで、一貫した体験を提供

**エラーパターンの認識:**
- 複数のレート制限パターンを検出（`status 429`、`rateLimitExceeded`、`Quota exceeded`など）
- パターンマッチングにより、様々なエラーレスポンス形式に対応

## パフォーマンスへの影響

### コマンドチェックの最適化

以前の実装では、各API呼び出しの前に`command -v timeout`を実行していました。この冗長な処理を削除し、スクリプト開始時の1回のチェックに統合しました。

**影響:**
- わずかながらパフォーマンスの向上
- コードの可読性とメンテナンス性の改善

## 将来の拡張性

### 環境変数による制御

現在の設計では、タイムアウト値は定数として定義されていますが、将来的には環境変数による制御を可能にする予定です：

```bash
GEMINI_TIMEOUT=${GEMINI_REVIEW_TIMEOUT:-120}
```

これにより、ユーザーや環境ごとの最適化が可能になります。

### メトリクスとモニタリング

将来的な改善として、以下の機能を検討しています：

1. **応答時間の記録**: 実際のAPI応答時間を記録し、最適なタイムアウト値を動的に調整
2. **タイムアウト発生率の追跡**: タイムアウトが頻繁に発生する場合の警告機能
3. **非同期処理**: 複数のレビュータスクを並行処理し、全体的な処理時間を短縮

## セキュリティとリソース管理

**リソース枯渇の防止:**
- タイムアウト機能により、無限ループや応答しないプロセスによるリソース枯渇を防止
- プロセスの適切な終了処理（TERM → KILL）により、ゾンビプロセスを防止

**安全な終了処理:**
```bash
kill -TERM $PID 2>/dev/null || true
sleep 2
kill -KILL $PID 2>/dev/null || true
```

この段階的な終了処理により、プロセスがクリーンアップ処理を実行する機会を提供しつつ、確実に終了させます。