# Gemini Review Hook タイムアウト変更の説明

## 変更履歴

### 1. 緊急修正 (commit a157484)
- **問題**: Gemini APIの呼び出しがハングし、Claudeのフックが終了できない状態が発生
- **対応**: 積極的なタイムアウト設定（15秒）とフォールバック処理を実装
- **結果**: ハング問題は解決したが、正常な処理も頻繁にタイムアウトする副作用が発生

### 2. 緊急修正のRevert (commit 63d6938)
- **理由**: 15秒のタイムアウトが短すぎて、正常なレビュー処理も中断される問題が判明
- **背景**: 
  - Gemini APIの応答時間は、プロンプトの長さやモデルの負荷により変動
  - 特に詳細なコードレビューでは、15秒では不十分なケースが多発
- **決定**: より適切なタイムアウト値を検討するため、一旦元の実装に戻す

### 3. タイムアウトを120秒に増加 (commit 3c40a0a)
- **根拠**:
  - 実際の計測で、Gemini Proモデルの応答時間は30-90秒の範囲
  - 120秒は、ネットワーク遅延や一時的な負荷も考慮した安全マージン
  - Claudeの全体的な処理時間への影響は限定的（他の処理は並行実行可能）
- **削除したコマンドチェック**:
  - `command -v timeout`のチェックを各実行前に行っていた冗長な処理を削除
  - 理由: スクリプト開始時の1回のチェックで十分であり、繰り返しは不要
  - 影響: パフォーマンスのわずかな改善、コードの簡潔性向上

### 4. Flashモデルのタイムアウト統一 (commit 14caa2e)
- **変更内容**: `flash_timeout=$((GEMINI_TIMEOUT / 2))` を削除し、`GEMINI_TIMEOUT`を統一使用
- **理由**:
  - Flashモデルは一般的に高速だが、レート制限時は処理が遅延する可能性
  - 異なるタイムアウト値は、デバッグとメンテナンスを複雑化
  - 統一により、設定の一貫性と予測可能性が向上
- **影響**: Flashモデルも120秒のタイムアウトを使用、安定性の向上

## 技術的詳細

### タイムアウト処理の実装
```bash
# timeoutコマンドが利用可能な場合
timeout ${GEMINI_TIMEOUT}s bash -c "echo '$REVIEW_PROMPT' | gemini -s -y"

# 利用不可能な場合の手動実装
echo "$REVIEW_PROMPT" | gemini -s -y &
GEMINI_PID=$!
# プロセス監視ループで手動タイムアウト管理
```

### セキュリティと安定性への配慮
- タイムアウトは、無限ループやリソース枯渇を防ぐセーフティネット
- コマンドチェックの削除は、機能面での影響なし（エラーハンドリングは維持）
- 統一されたタイムアウトにより、システム全体の挙動が予測可能に

## 今後の改善点
1. タイムアウト値の環境変数化を検討（ユーザーごとのカスタマイズ）
2. レスポンスタイムのメトリクス収集による最適値の継続的な調整
3. 非同期処理の導入による、より効率的なAPI呼び出しの実装